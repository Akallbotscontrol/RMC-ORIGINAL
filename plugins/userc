from pyrogram import Client, filters
from pyrogram.enums import ParseMode
from pyrogram.types import Message
from info import ADMIN
from utils import get_users
import io
import html

@Client.on_message(filters.command("userc") & filters.user(ADMIN))
async def user_counter(bot, message: Message):
    total, users = await get_users()

    if total == 0:
        return await message.reply("ðŸ˜• No users found in database.")

    users = sorted(users, key=lambda x: x.get('name', 'Unknown').lower())
    text = f"ðŸ“Š Total Users: <b>{total}</b>\n\n"

    for user in users:
        uid = user['_id']
        name = user.get('name', 'Unknown')
        text += f"â€¢ <code>{html.escape(name)}</code> | <code>{uid}</code>\n"

    if len(text) > 4096:
        output = io.StringIO()
        for user in users:
            uid = user['_id']
            name = user.get('name', 'Unknown')
            output.write(f"{name} - {uid}\n")
        output.seek(0)
        await message.reply_document(output, caption=f"ðŸ“¦ Total Users: {total}", filename="users.txt")
    else:
        await message.reply(text, parse_mode=ParseMode.HTML)
